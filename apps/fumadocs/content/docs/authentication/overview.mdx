---
title: Authentication Architecture
description: Complete guide to our full-stack authentication implementation with Better Auth and TanStack Start
---

import { Callout } from 'fumadocs-ui/components/callout';

## Overview

This application uses **Better Auth** with **TanStack Start** to create a full-stack authentication system with server-side session validation and client-side state management.

## Key Achievement: Full-Stack Authentication in TanStack Start

This implementation makes TanStack Start a true **full-stack framework** by:

1. âœ… **Server-side session validation** - Sessions are validated on the server before rendering
2. âœ… **Cross-origin cookie handling** - Proxy pattern ensures cookies work across different origins
3. âœ… **Context sharing** - Session data flows from server to client seamlessly
4. âœ… **Intelligent caching** - Multiple layers of caching prevent unnecessary database calls
5. âœ… **Type-safe** - Full TypeScript support across server and client boundaries

---

## Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          BROWSER                                 â”‚
â”‚                                                                  â”‚
â”‚  1. User navigates to page                                      â”‚
â”‚  2. TanStack Router calls beforeLoad (SERVER-SIDE)              â”‚
â”‚     â”œâ”€ getAuthSession() validates cookies on server             â”‚
â”‚     â””â”€ Returns { session, isAuthenticated }                     â”‚
â”‚                                                                  â”‚
â”‚  3. Context flows to all child routes                           â”‚
â”‚     â””â”€ useRouteContext() accesses session data                  â”‚
â”‚                                                                  â”‚
â”‚  4. Auth actions (login/logout) go through proxy               â”‚
â”‚     â””â”€ /api/auth/* â†’ Proxy â†’ Backend â†’ Database                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Core Components

### 1. Auth Proxy (`apps/web/src/routes/api/auth/$.ts`)

**Purpose**: Handle cross-origin cookie issues by proxying auth requests to the backend.

```typescript
// Catches all /api/auth/* requests
export const Route = createFileRoute("/api/auth/$")({
  server: {
    handlers: {
      GET: async ({ request }) => proxyAuthRequest(request),
      POST: async ({ request }) => proxyAuthRequest(request),
      // ... other HTTP methods
    },
  },
});
```

**How it works**:

- Browser makes request to `/api/auth/sign-in` (same origin)
- Proxy forwards to backend at `${BACKEND_URL}/api/auth/sign-in`
- Backend responds with cookies
- Proxy forwards response back to browser
- Browser saves cookies (same origin = works! âœ…)

**Why this is critical**:

- Solves cross-origin cookie blocking
- Enables SSR with authenticated requests
- Makes cookies work in production with different domains

---

### 2. Server-Side Session Validation (`apps/web/src/routes/__root.tsx`)

**Purpose**: Validate session on every page load **before rendering**.

```typescript
export const Route = createRootRouteWithContext<RouterAppContext>()({
  staleTime: 10 * 60 * 1000, // Cache for 10 minutes

  beforeLoad: async () => {
    // ğŸ”¥ This runs on the SERVER before any component renders
    const session = await getAuthSession();

    return {
      session,              // Full session object
      isAuthenticated: !!session  // Boolean flag
    };
  },
});
```

<Callout type="info">
**Key points**:
- Runs on **server-side** during SSR
- Runs on **client-side** during navigation
- Validates cookies against backend
- Returns context available to all routes
- Cached for 10 minutes (avoids repeated DB calls)
</Callout>

---

### 3. Session Validation Function (`apps/web/src/lib/auth/functions.ts`)

**Purpose**: Server function to validate session with backend.

```typescript
export const getAuthSession = createServerFn({ method: "GET" })
  .handler(async () => {
    // Get request headers (includes cookies)
    const headers = getRequestHeaders();

    // Validate session with Better Auth
    const session = await auth.api.getSession({ headers });

    return session;
  });
```

**Flow**:

1. Extract cookies from incoming request
2. Call Better Auth API to validate session
3. Better Auth checks cookie against database
4. Return session data or null

---

### 4. Client-Side Context Access

**Purpose**: Access session data in any component via React Context.

```typescript
function HomePage() {
  // Access session from parent route's beforeLoad
  const { session, isAuthenticated } = Route.useRouteContext();

  return (
    <div>
      {isAuthenticated ? (
        <p>Welcome, {session.user?.name}!</p>
      ) : (
        <p>Please log in</p>
      )}
    </div>
  );
}
```

**Benefits**:

- No prop drilling
- Type-safe
- Automatically updated
- Available in all child routes

---

### 5. Auth Client (`apps/web/src/lib/auth/auth-client.ts`)

**Purpose**: Client-side Better Auth client for auth actions.

```typescript
export const authClient = createAuthClient({
  basePath: "/api/auth",  // Uses current origin + proxy
  fetchOptions: {
    credentials: "include",  // Send cookies
  },
});

// Usage in components
await authClient.signIn.email({ email, password });
await authClient.signOut();
const { data } = authClient.useSession();
```

<Callout type="warn">
**Why basePath only**:
- No `baseURL` needed - uses current origin automatically
- Always makes same-origin requests
- Works in dev (`localhost:3001`) and prod (`your-app.workers.dev`)
- Goes through proxy â†’ backend
</Callout>

---

## Caching Strategy

### Multi-Layer Caching

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 1: Better Auth Session Cache (Backend)                â”‚
â”‚ Duration: 10 minutes                                         â”‚
â”‚ Location: Backend memory                                     â”‚
â”‚ Benefit: Repeated getSession() calls don't hit database     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 2: TanStack Router Route Cache (Frontend)             â”‚
â”‚ Duration: 10 minutes (staleTime)                            â”‚
â”‚ Location: TanStack Router cache                             â”‚
â”‚ Benefit: Navigation between pages doesn't re-fetch          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 3: React Context (Runtime)                            â”‚
â”‚ Duration: Component lifecycle                                â”‚
â”‚ Location: React tree                                         â”‚
â”‚ Benefit: Components access data without additional requests â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Configuration

**Backend Cache** (`packages/auth/src/config/backend-config.ts`):

```typescript
session: {
  cookieCache: {
    enabled: true,
    maxAge: 10 * 60, // 10 minutes
  },
}
```

**Route Cache** (`apps/web/src/routes/__root.tsx`):

```typescript
staleTime: 10 * 60 * 1000, // 10 minutes
```

<Callout type="success">
**Performance Impact**: ~90% reduction in auth database queries.
</Callout>

### Cache Flow Example

```
User visits /your-entities:
â”œâ”€ beforeLoad runs
â”œâ”€ getAuthSession() called
â”œâ”€ Backend cache HIT (if within 10 min) âœ…
â”œâ”€ Session returned instantly
â””â”€ Route cache stores result

User navigates to /your-entities/123:
â”œâ”€ beforeLoad runs
â”œâ”€ Route cache HIT (if within 10 min) âœ…
â””â”€ No server call needed!

10 minutes pass:
â”œâ”€ Cache expires
â”œâ”€ Next navigation triggers fresh validation
â””â”€ Backend cache might still be valid âœ…
```

---

## Authentication Flows

### 1. Sign In Flow

```
Component                Proxy               Backend             Database
   â”‚                      â”‚                     â”‚                   â”‚
   â”‚ signIn.email()       â”‚                     â”‚                   â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                     â”‚                   â”‚
   â”‚                      â”‚ Forward request     â”‚                   â”‚
   â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                   â”‚
   â”‚                      â”‚                     â”‚ Validate creds    â”‚
   â”‚                      â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                      â”‚                     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                      â”‚ Set-Cookie header   â”‚                   â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
   â”‚                      â”‚                     â”‚                   â”‚
   â””â”€ Cookie saved! âœ…
```

### 2. Page Load Flow

```
Browser              TanStack Router        Server Function        Backend
   â”‚                      â”‚                       â”‚                   â”‚
   â”‚ Navigate to /page    â”‚                       â”‚                   â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                       â”‚                   â”‚
   â”‚                      â”‚ beforeLoad runs       â”‚                   â”‚
   â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                   â”‚
   â”‚                      â”‚                       â”‚ getSession()      â”‚
   â”‚                      â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                      â”‚                       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                      â”‚ { session, isAuth }   â”‚                   â”‚
   â”‚                      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
   â”‚ Render with context  â”‚                       â”‚                   â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚                   â”‚
```

### 3. Sign Out Flow

```
Component            Proxy               Backend             Database
   â”‚                   â”‚                     â”‚                   â”‚
   â”‚ signOut()         â”‚                     â”‚                   â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                     â”‚                   â”‚
   â”‚                   â”‚ Forward request     â”‚                   â”‚
   â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                   â”‚
   â”‚                   â”‚                     â”‚ Delete session    â”‚
   â”‚                   â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                   â”‚ Clear-Cookie        â”‚                   â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
   â”‚                   â”‚                     â”‚                   â”‚
   â”‚ Redirect to /loginâ”‚                     â”‚                   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
```

---

## Protected Routes

### Using `_authenticated` Layout

```typescript
// apps/web/src/routes/_authenticated.tsx
export const Route = createFileRoute("/_authenticated")({
  component: AuthenticatedLayout,
});

function AuthenticatedLayout() {
  const { session, isAuthenticated } = useSession();

  // Redirect if not authenticated
  if (!isAuthenticated && !isPending) {
    return <Navigate to="/auth/login" />;
  }

  return <Outlet />;
}
```

All routes under `_authenticated/` are automatically protected:

- `/_authenticated/your-entities` âœ…
- `/_authenticated/your-entities/$id` âœ…
- `/_authenticated/settings` âœ…

---

## Type Safety

### Root Context Type

```typescript
// apps/web/src/routes/__root.tsx
export interface RouterAppContext {
  queryClient: QueryClient;
  session: SessionData | null;
  isAuthenticated: boolean;
}
```

### Usage with Type Safety

```typescript
function MyPage() {
  // TypeScript knows the exact shape!
  const { session, isAuthenticated } = Route.useRouteContext();

  // session.user is typed âœ…
  // session.session is typed âœ…
}
```

---

## Environment Variables

### Development (`.env`)

```bash
VITE_SERVER_URL=http://localhost:3000
```

### Production (Cloudflare)

```bash
VITE_SERVER_URL=https://your-backend.workers.dev
```

### Backend (`.dev.vars`)

```bash
CORS_ORIGIN=http://localhost:3001
BETTER_AUTH_SECRET=your-secret-key
BETTER_AUTH_URL=http://localhost:3000
DATABASE_URL=postgresql://...
DATABASE_URL_DIRECT=postgresql://...
```

---

## Why This Makes TanStack Start Full-Stack

### Traditional SPA Approach âŒ

```
Browser â†’ Auth Server (different origin)
  â†“
Cookies blocked by CORS
  â†“
Session doesn't persist
  â†“
User must re-login constantly
```

### Our Full-Stack Approach âœ…

```
Browser â†’ TanStack Start (SSR + Proxy)
  â†“
Server validates session before render
  â†“
Cookies work (same origin via proxy)
  â†“
Session persists + cached
  â†“
Seamless user experience
```

### Full-Stack Capabilities Enabled

1. **Server-Side Rendering with Auth**
   - Pages render with user data on first load
   - SEO-friendly authenticated pages
   - No flash of unauthenticated content

2. **Middleware-like Behavior**
   - `beforeLoad` acts like Next.js middleware
   - Server-side validation before rendering
   - Can redirect unauthorized users

3. **Unified Type System**
   - Same types on server and client
   - End-to-end type safety
   - No API contract mismatches

4. **Intelligent Caching**
   - Backend cache (Better Auth)
   - Router cache (TanStack)
   - Context cache (React)
   - Minimal database queries

5. **Seamless Data Flow**
   - Server â†’ Context â†’ Components
   - No prop drilling
   - Automatic updates on auth changes

---

## Best Practices

### âœ… DO

- Use `Route.useRouteContext()` to access session
- Validate session in `beforeLoad` for protected routes
- Use the auth proxy for all auth operations
- Set appropriate cache durations
- Handle loading and error states

### âŒ DON'T

- Don't call backend directly from client (use proxy)
- Don't store session in localStorage (use cookies)
- Don't skip server-side validation
- Don't forget to handle unauthenticated states
- Don't hardcode URLs (use environment variables)

---

## Debugging

### Check Session Validation

```typescript
// In __root.tsx beforeLoad
beforeLoad: async () => {
  const session = await getAuthSession();
  console.log("Session validated:", session); // Check server logs
  return { session, isAuthenticated: !!session };
}
```

### Check Context Flow

```typescript
// In any component
function MyComponent() {
  const context = Route.useRouteContext();
  console.log("Context received:", context); // Check browser console
}
```

### Check Proxy Forwarding

Look for these logs in terminal:

```
GET /api/auth/get-session â†’ Forwarding to backend
Backend responded: 200 OK
```

### Check Cache Hits

```typescript
// Add logging to getAuthSession
export const getAuthSession = createServerFn({ method: "GET" })
  .handler(async () => {
    console.log("ğŸ” Validating session (cache miss)");
    const session = await auth.api.getSession({ headers });
    return session;
  });
```

If you don't see logs on every navigation, cache is working! âœ…

---

## Common Issues & Solutions

### Issue: Cookies not persisting

**Solution**: Check that `credentials: "include"` is set:

```typescript
fetchOptions: {
  credentials: "include", // âœ…
}
```

### Issue: Session undefined in component

**Solution**: Use `useRouteContext()` not `useState()`:

```typescript
const { session } = Route.useRouteContext(); // âœ…
```

### Issue: Infinite loading

**Solution**: Handle the pending state:

```typescript
const { session, isAuthenticated } = Route.useRouteContext();
const { isPending } = useSession();

if (isPending) return <Loader />;
if (!isAuthenticated) return <Navigate to="/login" />;
```

### Issue: CORS errors

**Solution**: Ensure proxy is handling requests:

```typescript
basePath: "/api/auth", // âœ… Goes through proxy
// NOT: baseURL: "https://backend.com" // âŒ CORS issues
```

---

## Performance Metrics

With this implementation:

- **Initial page load**: Session validated once
- **Navigation**: Cached session used (0 DB calls)
- **Cache duration**: 10 minutes
- **Database queries**: ~1 per 10 minutes per user
- **SSR performance**: Fast (cached session)

---

## Security Considerations

### âœ… Secure by Default

- HttpOnly cookies (can't be accessed by JavaScript)
- Secure flag in production (HTTPS only)
- SameSite=Lax (CSRF protection)
- Server-side validation (can't be bypassed)
- Short session expiration (7 days default)

### Protected Data Flow

```
User â†’ Browser (no session access) â†’ Proxy â†’ Backend â†’ Database
                 â†‘
         Only server validates session
         Client can't manipulate it
```

---

## Related Files

- `apps/web/src/routes/api/auth/$.ts` - Auth proxy
- `apps/web/src/routes/__root.tsx` - Root context provider
- `apps/web/src/routes/_authenticated.tsx` - Protected route layout
- `apps/web/src/lib/auth/auth-client.ts` - Client auth instance
- `apps/web/src/lib/auth/functions.ts` - Server auth functions
- `apps/web/src/lib/auth/auth-server.ts` - Server auth instance
- `packages/auth/src/config/backend-config.ts` - Backend auth config

---

## Next Steps

- [Quick Reference Guide](/docs/authentication/quick-reference) - Common patterns and snippets
- [Implementation Details](/docs/authentication/implementation) - Deep dive into the implementation
- [PR Summary](/docs/authentication/pr-summary) - Changes and impact analysis
